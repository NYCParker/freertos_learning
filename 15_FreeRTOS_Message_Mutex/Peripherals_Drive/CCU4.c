
/*
CCU40 CC40 Timer定时器
CCU40 CC41 Capture捕获
CCU40 CC42 级联捕获
*/

#include <XMC4400.h>
#include "CCU4.h"

#define CCU40_CC40_DIV_VAL	12
#define CCU40_CC40_PRS_VAL	14648    //Timer  (1/120 000 000)*(2^DIV_VAL)*(PRS_VAL s+1)    ~0.5s

#define CCU40_CC41_DIV_VAL  9
#define CCU40_CC41_PRS_VAL  0xFFFF   //Capture mode 周期值设满 

#define CCU40_CC42_DIV_VAL  9
#define CCU40_CC42_PRS_VAL  0xFFFF   //捕获级联

void CCU4_Init(void)
{
    WR_REG(SCU_RESET->PRSET0, SCU_RESET_PRSET0_CCU40RS_Msk, SCU_RESET_PRSET0_CCU40RS_Pos, 1);
	WR_REG(SCU_RESET->PRCLR0, SCU_RESET_PRCLR0_CCU40RS_Msk, SCU_RESET_PRCLR0_CCU40RS_Pos, 1);	
	WR_REG(SCU_CLK->CLKSET, SCU_CLK_CLKSET_CCUCEN_Msk, SCU_CLK_CLKSET_CCUCEN_Pos, 1);	
	
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_SPRB_Msk, CCU4_GIDLC_SPRB_Pos, 1);
	WR_REG(CCU40_CC40->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, CCU40_CC40_DIV_VAL);  //分频
	WR_REG(CCU40_CC40->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, CCU40_CC40_PRS_VAL);    //周期值
	WR_REG(CCU40->GCSS, CCU4_GCSS_S0SE_Msk, CCU4_GCSS_S0SE_Pos, 1);                             //传送周期值
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS0I_Msk, CCU4_GIDLC_CS0I_Pos, 1);	                        //启用定时器片
	WR_REG(CCU40_CC40->INTE, CCU4_CC4_INTE_PME_Msk, CCU4_CC4_INTE_PME_Pos, 1);
	WR_REG(CCU40_CC40->SRS, CCU4_CC4_SRS_POSR_Msk, CCU4_CC4_SRS_POSR_Pos, 0);                   //周期匹配中断至SR0
	
	WR_REG(CCU40_CC41->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, CCU40_CC41_DIV_VAL);
	WR_REG(CCU40_CC41->TC, CCU4_CC4_TC_CMOD_Msk, CCU4_CC4_TC_CMOD_Pos, 1);                      //捕获模式
	WR_REG(CCU40_CC41->TC, CCU4_CC4_TC_CAPC_Msk, CCU4_CC4_TC_CAPC_Pos, 3);                      //捕获清空定时器
	WR_REG(CCU40_CC41->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 0);                 //事件0 P1.2
	WR_REG(CCU40_CC41->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);                 //上升沿有效
	WR_REG(CCU40_CC41->CMC, CCU4_CC4_CMC_CAP0S_Msk, CCU4_CC4_CMC_CAP0S_Pos, 1);                 //事件0：捕获
	WR_REG(CCU40_CC41->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, CCU40_CC41_PRS_VAL); 
	WR_REG(CCU40->GCSS, CCU4_GCSS_S1SE_Msk, CCU4_GCSS_S1SE_Pos, 1);              
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS1I_Msk, CCU4_GIDLC_CS1I_Pos, 1);
	WR_REG(CCU40_CC41->INTE, CCU4_CC4_INTE_E0AE_Msk, CCU4_CC4_INTE_E0AE_Pos, 1);		
	WR_REG(CCU40_CC41->SRS, CCU4_CC4_SRS_E0SR_Msk, CCU4_CC4_SRS_E0SR_Pos, 1);                   //捕获中断SR1（其实是外部事件中断）
	
	WR_REG(CCU40_CC42->PSC, CCU4_CC4_PSC_PSIV_Msk, CCU4_CC4_PSC_PSIV_Pos, CCU40_CC42_DIV_VAL);
	WR_REG(CCU40_CC42->TC, CCU4_CC4_TC_CMOD_Msk, CCU4_CC4_TC_CMOD_Pos, 1);                      
	WR_REG(CCU40_CC42->TC, CCU4_CC4_TC_CAPC_Msk, CCU4_CC4_TC_CAPC_Pos, 3);                   
	WR_REG(CCU40_CC42->INS, CCU4_CC4_INS_EV0IS_Msk, CCU4_CC4_INS_EV0IS_Pos, 0);                
	WR_REG(CCU40_CC42->INS, CCU4_CC4_INS_EV0EM_Msk, CCU4_CC4_INS_EV0EM_Pos, 1);                 
	WR_REG(CCU40_CC42->CMC, CCU4_CC4_CMC_CAP0S_Msk, CCU4_CC4_CMC_CAP0S_Pos, 1);                
	WR_REG(CCU40_CC42->CMC, CCU4_CC4_CMC_TCE_Msk, CCU4_CC4_CMC_TCE_Pos, 1);                     //级联捕获
	WR_REG(CCU40_CC42->PRS, CCU4_CC4_PRS_PRS_Msk, CCU4_CC4_PRS_PRS_Pos, CCU40_CC42_PRS_VAL); 
	WR_REG(CCU40->GCSS, CCU4_GCSS_S2SE_Msk, CCU4_GCSS_S2SE_Pos, 1);              
	WR_REG(CCU40->GIDLC, CCU4_GIDLC_CS2I_Msk, CCU4_GIDLC_CS2I_Pos, 1);	
}

void CCU40_CC40_Start()
{
	WR_REG(CCU40_CC40->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC40
}

void CCU40_CC41_Start()
{
	WR_REG(CCU40_CC41->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC40
}

void CCU40_CC42_Start()
{
	WR_REG(CCU40_CC42->TCSET, CCU4_CC4_TCSET_TRBS_Msk, CCU4_CC4_TCSET_TRBS_Pos, 1);//启动CCU40_CC40
}
